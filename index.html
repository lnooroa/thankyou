<!DOCTYPE html>
<html>
<head>
    <title>Collaborative Housing Projects</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .menu { margin-bottom: 20px; }
        .menu-item { margin-right: 15px; cursor: pointer; color: blue; text-decoration: underline; }
        .header-large { font-size: 24px; font-weight: bold; }
        .footer-small { font-size: 12px; color: gray; }
        .table-striped tr:nth-child(even) { background-color: #f9f9f9; }
        table { border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        .debug { margin-top: 20px; color: red; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="menu" class="menu"></div>
    <div id="content"></div>
    <div id="debug" class="debug"></div>

    <script>
        const SHEETS_API_URL = "https://sheets.googleapis.com/v4/spreadsheets";
        const SHEET_ID = "1nIvuosTOZolBb4eoyBb-dZOufKW1-9kgRwB4galSUlM"; // Replace with your Google Sheet ID
        const API_KEY = "AIzaSyDauOae1oqVgzKL5LLcX7E2H3DqwvSd5PM"; // Replace with your Google API Key

        // Helper function to log debug messages
        function debugLog(message) {
            const debugDiv = document.getElementById("debug");
            debugDiv.textContent += message + "\n";
        }

        // Fetch all sheet names to dynamically generate the menu
        async function fetchSheetNames() {
            try {
                const url = `${SHEETS_API_URL}/${SHEET_ID}?key=${API_KEY}`;
                debugLog(`Fetching sheet names from: ${url}`);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                debugLog("Sheet names fetched successfully!");
                return data.sheets.map(sheet => sheet.properties.title);
            } catch (error) {
                debugLog(`Error fetching sheet names: ${error.message}`);
                return [];
            }
        }

        // Fetch specific sheet content
        async function fetchSheet(sheetName) {
            try {
                const url = `${SHEETS_API_URL}/${SHEET_ID}/values/${sheetName}?key=${API_KEY}`;
                debugLog(`Fetching sheet: ${sheetName} from: ${url}`);
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                debugLog(`Sheet "${sheetName}" fetched successfully!`);
                return data.values;
            } catch (error) {
                debugLog(`Error fetching sheet "${sheetName}": ${error.message}`);
                return [];
            }
        }

        // Render the menu
        async function renderMenu() {
            debugLog("Rendering menu...");
            const sheetNames = await fetchSheetNames();
            const menuDiv = document.getElementById("menu");

            if (sheetNames.length === 0) {
                debugLog("No sheets found or failed to fetch sheet names.");
                return;
            }

            sheetNames.filter(name => name.startsWith("w_")).forEach(name => {
                const menuName = name.replace("w_", "").replace("_", " "); // Clean up name
                const link = document.createElement("span");
                link.innerText = menuName;
                link.className = "menu-item";
                link.onclick = () => loadPage(name);
                menuDiv.appendChild(link);
            });

            debugLog("Menu rendered successfully.");
        }

        // Load and render a web page
        async function loadPage(sheetName) {
            debugLog(`Loading page: ${sheetName}`);
            const pageData = await fetchSheet(sheetName);
            const contentDiv = document.getElementById("content");
            contentDiv.innerHTML = ""; // Clear previous content

            if (pageData.length === 0) {
                debugLog(`No data found for page: ${sheetName}`);
                return;
            }

            pageData.forEach(row => {
                row.forEach(cellContent => {
                    if (cellContent.startsWith("{")) {
                        // Handle special keywords
                        if (cellContent.startsWith("{style:")) {
                            const styleClass = cellContent.match(/\{style: (.*?)\}/)[1];
                            const styledDiv = document.createElement("div");
                            styledDiv.className = styleClass;
                            styledDiv.innerText = cellContent.replace(/\{style:.*?\}/, "").trim(); // Remove {style:}
                            contentDiv.appendChild(styledDiv);
                        } else if (cellContent.startsWith("{table:")) {
                            const tableParams = cellContent.match(/\{table: (.*?)(,.*?)*\}/)[1];
                            const filters = cellContent.match(/filter: (.*?),/);
                            const sort = cellContent.match(/sort: (.*?)\}/);
                            renderTable(tableParams, filters, sort, contentDiv);
                        }
                    } else if (cellContent.trim() !== "") {
                        // Static text
                        const textDiv = document.createElement("div");
                        textDiv.innerText = cellContent;
                        contentDiv.appendChild(textDiv);
                    }
                });
            });

            debugLog(`Page "${sheetName}" loaded successfully.`);
        }

        // Render a table
        async function renderTable(tableName, filters, sort, container) {
            debugLog(`Rendering table: ${tableName}`);
            const tableData = await fetchSheet(tableName);

            if (tableData.length === 0) {
                debugLog(`No data found for table: ${tableName}`);
                return;
            }

            const table = document.createElement("table");
            table.className = "table-striped";
            const headers = tableData[0];
            let rows = tableData.slice(1);

            // Apply filters
            if (filters) {
                const [filterColumn, filterValue] = filters[1].split("=");
                rows = rows.filter(row => row[headers.indexOf(filterColumn.trim())] === filterValue.trim());
            }

            // Apply sorting
            if (sort) {
                const [sortColumn, sortDirection] = sort[1].split(" ");
                const colIndex = headers.indexOf(sortColumn.trim());
                rows.sort((a, b) => {
                    if (sortDirection === "ASC") return a[colIndex] > b[colIndex] ? 1 : -1;
                    else return a[colIndex] < b[colIndex] ? 1 : -1;
                });
            }

            // Create table header
            const thead = document.createElement("thead");
            const headerRow = document.createElement("tr");
            headers.forEach(header => {
                const th = document.createElement("th");
                th.innerText = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create table body
            const tbody = document.createElement("tbody");
            rows.forEach(row => {
                const tr = document.createElement("tr");
                row.forEach(cell => {
                    const td = document.createElement("td");
                    td.innerText = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            container.appendChild(table);
            debugLog(`Table "${tableName}" rendered successfully.`);
        }

        // Initialize
        debugLog("Initializing...");
        renderMenu();
        loadPage("w_home"); // Default to home page
    </script>
</body>
</html>
